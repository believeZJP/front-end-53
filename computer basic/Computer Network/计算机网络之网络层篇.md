## 虚拟互联网络

- 实际的计算机网络是错综复杂的
- 物理设备通过使用IP协议，屏蔽了物理网络之间的差异
- 当网络中的主机使用IP协议连接时，则无需关注网络细节
- IP协议使得复杂的实际网络编程一个虚拟互连的网络
- IP协议使得网络层可以屏蔽底层细节而专注网络层的数据转发
- IP协议解决了在虚拟网络中数据报“传输路径”的问题！！！
- IP地址常使用点分十进制来表示(0~255.0~255.0~255.0~255)，总共可以有2的23次方个。

![](https://s2.ax1x.com/2019/11/15/MUcTc6.md.png)

#### ip数据的组成

![xxx](https://s2.ax1x.com/2019/11/15/MUcqBD.md.png)

![MUcLHe.md.png](https://s2.ax1x.com/2019/11/15/MUcLHe.md.png)

- 版本:占4位,指的是IP协议的版本，通信双方的版本必须一致，当前主流版本是4,即IPv4 ,也有IPv6
- 首部位长度:占4位,最大数值为15，表示的是IP首部长度,单位是"32位字” (4个字节)也即是IP首部最大长度为60字节
- 总长度:占16位，最大数值为65535,表示的是IP数据报总长度(IP首部+ IP数据)，数据链路层MTU一般是1500，如果ip报文较大，则数据链路层会分片进行传输。
- TTL:占8位,表明IP数据报文在网络中的寿命，每经过一个设备，TTL减1,当TTL=0时,网络设备必须丢弃该报文
- 协议:占8位，表明IP数据所携带的具体数据是什么协议的(如: TCP、 UDP等)
- ![](https://s2.ax1x.com/2019/11/15/MU2ZZD.md.png)
- 协议表中IP的的值是4，不要奇怪，ip也行封装ip协议进行传输。就行ip传输TCP协议一样。
- 首部校验和:占16位,校验IP首部是否有出错

## IP协议的转发流程

- 逐跳(hop-by-hop)
- 计算机和路由器都有路由表
- 路由表概念
- ![](https://s2.ax1x.com/2019/11/19/Mc4ict.md.png)
- 数据帧每一跳的MAC地址都在变化
- P数据报每一跳的P地址始终不变
- 

#### IP 协议的转发流程

![](https://s2.ax1x.com/2019/11/19/McIKO0.md.png)

基本流程：

1. A发出目的地为C的IP数据报，查询路由表发现下一跳为E
2. A将数据报发送给E
3. E查询路由表发现下一跳为F， 将数据报发送给F
4. F查询路由表发现目的地C直接连接，将数据报发送给C

结合数据链路层的流程：

1. A发出目的地为C的IP数据报，查询路由表发现下一跳为E
2. A将IP数据报交给数据链路层，并告知目的MAC地址是E
3. 数据链路层填充源MAC地址A和目的MAC地址E
4. 数据链路层通过物理层将数据发送给E
5. E的数据链路层接收到数据帧,把帧数据交给网络层
6. E查询路由表,发现下一跳为F
7. E把数据报交给数据链路层,并告知目的MAC地址为F
8. E的数据链路层封装数据帧并发送
9. F的数据链路层接收到数据帧,把帧数据交给网络层
10. F查询路由表,发现下一跳为C
11. F把数据报交给数据链路层,并告知目的MAC地址为C
12. F的数据链路层封装数据帧并发送

## ARP 协议和 RARP协议

- ARP(Address Resolution P!rotocol) 地址解析协议
- 将网络层IP32位地址转换成数据链路层MAC48位地址
- ARP缓存表
- ![](https://s2.ax1x.com/2019/11/19/McoX2d.md.png)
- ARP缓存表是ARP协议和RARP协议运行的关键
- ARP缓存表缓存了P地址到硬件地址之间的映射关系
- ARP缓存表中的记录并不是永久有效的,有一定的期限
- ![](https://s2.ax1x.com/2019/11/19/McTliF.md.png)
- RARP(Reverse Address Resolution P!rotocol) 逆地址解析协议，是将数据链路层MAC48位地址转换成网络层IP32位地址，现在很少使用了
- arp -a 查看本机的arp映射表

## IP地址的子网划分

- 对大约42亿个ip地址进行规划

|         | 网络号       | 主机号 |
| ------- | ------------ | ------ |
| A类地址 | 8位 首位0    | 24位   |
| B类地址 | 16位 首位10  | 26位   |
| C类地址 | 24位 首位110 | 8位    |



#### 特殊主机号

- 主机号全0表示当前网络段，不可分配为特定主机，例如1.0.0.0
- 主机号为全1表示广播地址，向当前网络段所有主机发消息，例如1.255.255.255

#### 特殊网络号

- A类地址网络段全0(00000000)表示特殊网络
- A类地址网络段后7位全1(01111111:127)表示回环地址
- B类地址网络段(10000000.00000000:128.0)是不可使用的
- C类地址网络段(192.0.0)是不可使用的
- 127.0.0.1,通常被称为本地回环地址(Loopback Address),不属于任何一个有类别地址类。它代表设备的本地虚拟接口，所以默认被看作是永远不会宕掉的接口。在Windows操作系统中也有相似的定义，所以通常在安装网卡前就可以ping通这个本地回环地址。一般都会用来检查本地网络协议、基本数据接口等是否正常的。

![](https://s1.ax1x.com/2019/11/20/MR5JBt.md.png)

#### 子网划分

![](https://s1.ax1x.com/2019/11/20/MR5YHP.md.png)



## NAT 技术

- 有这个技术主要是因为ip地址不够用了
-  ip分为内网地址和外网地址
- 网络地址转换NAT(Network Address Translation)
- NAT技术用于多个主机通过一个共有IP访问互联网的私有网络中 
- NAT减缓了IP地址的消耗，但是增加了网络通讯的复杂度

#### 内网地址分为三类

- 10.0.0.0 - 10.255.255.255 （支持千万数量级设备）
- 172.16.0.0 - 172.31.255.255 （支持百万数量级设备）
- 192.168.0.0 - 192.168.255.255 （支持万数量级设备）

#### NAT process

![](https://s2.ax1x.com/2019/11/23/MHtcuV.md.png)



## ICMP协议

- 网络控制报文协议（Internet Control Message Protocol）
- 辅助IP进行数据传输的
- ICMP协议可以报告错误信息或者异常情况

![](https://s2.ax1x.com/2019/11/23/MHtgBT.md.png)

两种报文格式：

- 差错报告报文
- ![](https://s2.ax1x.com/2019/11/23/MHtWEF.md.png)



- 询问报文
- ![](https://s2.ax1x.com/2019/11/23/MHtfN4.md.png)

## ICMP协议的应用

#### ping其实就是使用的icmp的询问报文

如何用ping排查网络故障

- ping 回环地址127.0.0.1，如果有问题说明是自己的网卡有问题。
- ping 网关地址（一般是192.168.0.1），如果有问题，说明自己的局域网有问题，排查网线的连接情况
- ping远端地址，如果有问题就找电信、联通、等把ISP吧

#### traceroute应用

- 当TTL寿命为0的时候，会发出一个ICMP终点不可达差错报文
- traceroute巧妙的利用的TTL的特性
- 具体测试流程见视频
- tracert github.com

## 路由概述

- 下一跳地址是怎么来的？
- 下一跳地址是唯一的吗？
- 下一跳地址是最佳的吗？
- 路由器这么多，他们是怎么协同工作的？
- 路由算法实际上就是图论的算法
- 一个自治系统（AS）是处于一个管理机构下的网络设备群
- AS内部网络自行管理，AS对外提供一个或者多个出（入）口
- 自治系统内部路由的协议称为：内部网关协议（RIP、OSPF）
- 自制系统外部路由的协议称为：外部网关协议（BGP）



## rip协议

#### 距离矢量（DV）算法

略，看视频。

#### RIP协议的过程

- RIP（Routing Information Protocol）协议
- RIP协议是使用DV算法的一种路由协议
- RIP协议把网络的跳数（hop）作为DV算法的距离
- RIP协议每隔30s交换一次路由信息
- RIP协议认为跳数>15的路由则为不可达路由
- 具体过程略
- 缺点故障信息传递慢
- 实现简单，开销很小；限制了网络的规模；“坏消息传递慢”，更新收敛时间过长；

## dijkstra（迪杰斯特拉）算法

- 解决有权图从一个节点到其他节点的最短路径问题
- 以起点为中心，向外层层扩展
- 两个集合找最短距离，必须掌握。



## ospf协议

#### 链路状态协议（LS）

- 向所有的路由器发送消息
  - 每个路由器都可以获得网络中的所有信息，也就是“网络的完整拓扑”
  - 也称之为“链路状态数据库”
  - “链路状态数据库”是全网一致的
  - 这就为运行 dijkstra 算法提供了前提
- 消息描述该路由器与相邻路由器的链路状态（距离，时延，带宽...）
  - 更客观、更加先进
- 只有链路状态发生变化时，才发送更新信息
  - 减少了数据的交换，更快收敛

#### ospf协议

- OSPF（Open Shortest Path First：开放最短路径优先）
- 核心是 dijkstra（迪杰斯特拉）算法

#### 五种消息类型

- 问候消息（Hello）
- 链路状态数据库描述信息
- 链路状态请求消息
- 链路状态更新消息
- 链路状态确认消息

#### rip协议和ospf协议的比较

![](https://s2.ax1x.com/2019/11/24/MOmZJP.md.png)

## bgp协议



