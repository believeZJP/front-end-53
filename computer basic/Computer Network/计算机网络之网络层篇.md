## 虚拟互联网络

- 实际的计算机网络是错综复杂的
- 物理设备通过使用IP协议，屏蔽了物理网络之间的差异
- 当网络中的主机使用IP协议连接时，则无需关注网络细节
- IP协议使得复杂的实际网络编程一个虚拟互连的网络
- IP协议使得网络层可以屏蔽底层细节而专注网络层的数据转发
- IP协议解决了在虚拟网络中数据报“传输路径”的问题！！！
- IP地址常使用点分十进制来表示(0~255.0~255.0~255.0~255)，总共可以有2的23次方个。

![](https://s2.ax1x.com/2019/11/15/MUcTc6.md.png)

#### ip数据的组成

![xxx](https://s2.ax1x.com/2019/11/15/MUcqBD.md.png)

![MUcLHe.md.png](https://s2.ax1x.com/2019/11/15/MUcLHe.md.png)

- 版本:占4位,指的是IP协议的版本，通信双方的版本必须一致，当前主流版本是4,即IPv4 ,也有IPv6
- 首部位长度:占4位,最大数值为15，表示的是IP首部长度,单位是"32位字” (4个字节)也即是IP首部最大长度为60字节
- 总长度:占16位，最大数值为65535,表示的是IP数据报总长度(IP首部+ IP数据)，数据链路层MTU一般是1500，如果ip报文较大，则数据链路层会分片进行传输。
- TTL:占8位,表明IP数据报文在网络中的寿命，每经过一个设备，TTL减1,当TTL=0时,网络设备必须丢弃该报文
- 协议:占8位，表明IP数据所携带的具体数据是什么协议的(如: TCP、 UDP等)
- ![](https://s2.ax1x.com/2019/11/15/MU2ZZD.md.png)
- 协议表中IP的的值是4，不要奇怪，ip也行封装ip协议进行传输。就行ip传输TCP协议一样。
- 首部校验和:占16位,校验IP首部是否有出错

## IP协议的转发流程

- 逐跳(hop-by-hop)
- 计算机和路由器都有路由表
- 路由表概念
- ![](https://s2.ax1x.com/2019/11/19/Mc4ict.md.png)
- 数据帧每一跳的MAC地址都在变化
- P数据报每一跳的P地址始终不变
- 

#### IP 协议的转发流程

![](https://s2.ax1x.com/2019/11/19/McIKO0.md.png)

基本流程：

1. A发出目的地为C的IP数据报，查询路由表发现下一跳为E
2. A将数据报发送给E
3. E查询路由表发现下一跳为F， 将数据报发送给F
4. F查询路由表发现目的地C直接连接，将数据报发送给C

结合数据链路层的流程：

1. A发出目的地为C的IP数据报，查询路由表发现下一跳为E
2. A将IP数据报交给数据链路层，并告知目的MAC地址是E
3. 数据链路层填充源MAC地址A和目的MAC地址E
4. 数据链路层通过物理层将数据发送给E
5. E的数据链路层接收到数据帧,把帧数据交给网络层
6. E查询路由表,发现下一跳为F
7. E把数据报交给数据链路层,并告知目的MAC地址为F
8. E的数据链路层封装数据帧并发送
9. F的数据链路层接收到数据帧,把帧数据交给网络层
10. F查询路由表,发现下一跳为C
11. F把数据报交给数据链路层,并告知目的MAC地址为C
12. F的数据链路层封装数据帧并发送

## ARP 协议和 RARP协议

- ARP(Address Resolution P!rotocol) 地址解析协议
- 将网络层IP32位地址转换成数据链路层MAC48位地址
- ARP缓存表
- ![](https://s2.ax1x.com/2019/11/19/McoX2d.md.png)
- ARP缓存表是ARP协议和RARP协议运行的关键
- ARP缓存表缓存了P地址到硬件地址之间的映射关系
- ARP缓存表中的记录并不是永久有效的,有一定的期限
- ![](https://s2.ax1x.com/2019/11/19/McTliF.md.png)
- RARP(Reverse Address Resolution P!rotocol) 逆地址解析协议，是将数据链路层MAC48位地址转换成网络层IP32位地址，现在很少使用了
- arp -a 查看本机的arp映射表

